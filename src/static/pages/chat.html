<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Mentator LLM Service</title>
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <div id="app">
        <div class="banner">
            <div class="banner-title">
                <a href="/">MENTATOR-LLM-SERVICE, VERSION {{ version }}</a>
            </div>
            <div class="banner-subtitle">chat</div>
        </div>

        <div class="main-content">
            <div class="chat-container">
                <!-- Top section -->
                <div class="chat-top-section" :style="{ height: topHeight + 'px' }">
                    <!-- Row 1: Type, Model, Format, Options -->
                    <div class="form-row">
                        <div class="form-group fixed-width">
                            <span class="form-label">type</span>
                            <select v-model="messageType" class="form-select">
                                <option value="system">system</option>
                                <option value="user">user</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <span class="form-label">model</span>
                            <select v-model="selectedModel" class="form-select">
                                <option v-for="model in models" :key="model" :value="model">{{ model }}</option>
                            </select>
                        </div>
                        <button class="form-button width-120" @click="onFormatClick">format</button>
                        <button class="form-button width-120" @click="onOptionsClick">options</button>
                    </div>

                    <!-- Row 2: Request textarea -->
                    <div class="textarea-container">
                        <div class="form-group" style="flex: 1; display: flex;">
                            <span class="form-label" ref="requestLabel">request</span>
                            <textarea
                                v-model="request"
                                class="form-textarea"
                                placeholder="Enter your request here..."
                                spellcheck="false"
                                @scroll="onRequestScroll"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Row 3: Load, Save and Send buttons -->
                    <div class="button-group button-group-space-between">
                        <div class="button-group">
                            <button class="form-button width-120" @click="onLoadClick">load</button>
                            <button class="form-button width-120" @click="onSaveClick">save</button>
                        </div>
                        <button class="form-button width-120" @click="onSendClick">send</button>
                    </div>
                </div>

                <!-- Splitter -->
                <div
                    class="splitter"
                    @mousedown="startDrag"
                    @touchstart="startDrag"
                ></div>

                <!-- Bottom section -->
                <div class="chat-bottom-section" :style="{ height: bottomHeight + 'px' }">
                    <!-- Row 5: Response textarea -->
                    <div class="textarea-container">
                        <div class="form-group" style="flex: 1; display: flex;">
                            <span class="form-label" ref="responseLabel">response</span>
                            <textarea
                                v-model="response"
                                class="form-textarea"
                                placeholder="Response will appear here..."
                                spellcheck="false"
                                readonly
                                @scroll="onResponseScroll"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Row 6: Export buttons -->
                    <div class="button-group">
                        <button class="form-button width-220" @click="onCopyAllClick">to clipboard all</button>
                        <button class="form-button width-220" @click="onCopyPayloadClick">to clipboard payload</button>
                        <button class="form-button width-220" @click="onSaveAllClick">to file all</button>
                        <button class="form-button width-220" @click="onSavePayloadClick">to file payload</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Format Modal -->
        <div v-if="formatModalOpen" class="modal-backdrop" @click.self="onFormatCancel" @keydown.esc="onFormatCancel">
            <div class="modal-window" role="dialog" aria-labelledby="modal-title" aria-modal="true">
                <h2 id="modal-title" class="modal-title">Format Response</h2>

                <div class="modal-form-group">
                    <textarea
                        ref="formatTextarea"
                        v-model="formatSchema"
                        class="modal-textarea"
                        :class="formatValidationClass"
                        placeholder="Enter JSON Schema..."
                        spellcheck="false"
                        @input="onFormatTextareaInput"
                    ></textarea>
                    <div v-if="formatErrorMessage" class="modal-error">{{ formatErrorMessage }}</div>
                </div>

                <div class="modal-controls">
                    <div class="modal-left-controls">
                        <button class="form-button width-120" @click="onFormatCheck">check</button>
                        <div class="modal-checkbox-group" title="Convert JSON Schema to GBNF grammar to enforce valid JSON output from LLM">
                            <input
                                type="checkbox"
                                id="use-grammar"
                                v-model="formatUseGrammar"
                            />
                            <label for="use-grammar">use grammar</label>
                        </div>
                    </div>
                    <div class="modal-right-controls">
                        <button class="form-button width-120" @click="onFormatOk">ok</button>
                        <button class="form-button width-120 button-cancel" @click="onFormatCancel">cancel</button>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="https://json-schema.org/understanding-json-schema" target="_blank" class="modal-link">JSON Schema Documentation</a>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/lib/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    version: '0.0.0',
                    messageType: 'user',
                    selectedModel: 'model-1',
                    models: [
                        'model-1',
                        'model-2',
                        'model-3'
                    ],
                    request: '',
                    response: '',
                    topHeight: 0,
                    bottomHeight: 0,
                    isDragging: false,
                    startY: 0,
                    startTopHeight: 0,
                    // Format modal state
                    formatModalOpen: false,
                    formatSchema: '',
                    formatUseGrammar: true,
                    formatValidationState: null, // null, 'valid', or 'invalid'
                    formatErrorMessage: ''
                }
            },
            computed: {
                formatValidationClass() {
                    if (this.formatValidationState === 'valid') return 'valid'
                    if (this.formatValidationState === 'invalid') return 'invalid'
                    return ''
                }
            },
            mounted() {
                // Load version
                fetch('/api/version')
                    .then(res => res.json())
                    .then(data => {
                        this.version = data.version
                    })
                    .catch(err => {
                        console.error('Failed to load version:', err)
                    })

                // Initialize heights
                this.initializeHeights()

                // Add global mouse/touch event listeners
                document.addEventListener('mousemove', this.onDrag)
                document.addEventListener('mouseup', this.stopDrag)
                document.addEventListener('touchmove', this.onDrag)
                document.addEventListener('touchend', this.stopDrag)

                // Handle window resize
                window.addEventListener('resize', this.initializeHeights)

                // Handle ESC key globally
                document.addEventListener('keydown', this.handleEscKey)
            },
            beforeUnmount() {
                document.removeEventListener('mousemove', this.onDrag)
                document.removeEventListener('mouseup', this.stopDrag)
                document.removeEventListener('touchmove', this.onDrag)
                document.removeEventListener('touchend', this.stopDrag)
                window.removeEventListener('resize', this.initializeHeights)
                document.removeEventListener('keydown', this.handleEscKey)
            },
            methods: {
                // Format modal - localStorage helpers
                loadFormatSettings() {
                    try {
                        const saved = localStorage.getItem('format')
                        if (saved) {
                            const parsed = JSON.parse(saved)
                            this.formatSchema = parsed.schema || this.getDefaultSchema()
                            this.formatUseGrammar = parsed.useGrammar !== undefined ? parsed.useGrammar : true
                        } else {
                            this.formatSchema = this.getDefaultSchema()
                            this.formatUseGrammar = true
                        }
                    } catch (err) {
                        console.error('Failed to load format settings:', err)
                        this.formatSchema = this.getDefaultSchema()
                        this.formatUseGrammar = true
                    }
                },
                saveFormatSettings() {
                    try {
                        const settings = {
                            schema: this.formatSchema,
                            useGrammar: this.formatUseGrammar
                        }
                        localStorage.setItem('format', JSON.stringify(settings))
                    } catch (err) {
                        console.error('Failed to save format settings:', err)
                        if (err.name === 'QuotaExceededError') {
                            alert('Failed to save: localStorage quota exceeded. Please reduce the schema size.')
                        }
                    }
                },
                getDefaultSchema() {
                    return `{
  "type": "array",
  "items": {
    "type": "object",
    "properties": {
      "name": {
        "type": "string"
      },
      "age": {
        "type": "number"
      }
    },
    "required": ["name", "age"]
  }
}`
                },
                initializeHeights() {
                    const container = document.querySelector('.chat-container')
                    if (!container) return

                    const totalHeight = container.clientHeight
                    const splitterHeight = 8
                    const topRowsHeight = 48 + 12 + 48 + 12 // two rows + gaps
                    const bottomRowHeight = 48 + 12 // one row + gap
                    const availableHeight = totalHeight - splitterHeight - topRowsHeight - bottomRowHeight

                    // Load saved position from localStorage or use 50/50 split
                    const savedRatio = localStorage.getItem('chat-splitter-ratio')
                    const ratio = savedRatio ? parseFloat(savedRatio) : 0.5

                    this.topHeight = topRowsHeight + (availableHeight * ratio)
                    this.bottomHeight = bottomRowHeight + (availableHeight * (1 - ratio))
                },
                startDrag(e) {
                    this.isDragging = true
                    this.startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY
                    this.startTopHeight = this.topHeight
                    e.preventDefault()
                },
                onDrag(e) {
                    if (!this.isDragging) return

                    const currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY
                    const deltaY = currentY - this.startY

                    const container = document.querySelector('.chat-container')
                    const totalHeight = container.clientHeight
                    const splitterHeight = 8
                    const topRowsHeight = 48 + 12 + 48 + 12
                    const bottomRowHeight = 48 + 12
                    const availableHeight = totalHeight - splitterHeight - topRowsHeight - bottomRowHeight

                    let newTopHeight = this.startTopHeight + deltaY
                    let newBottomHeight = totalHeight - newTopHeight - splitterHeight

                    // Calculate ratio for the available (textarea) space
                    const topTextareaHeight = newTopHeight - topRowsHeight
                    const ratio = topTextareaHeight / availableHeight

                    // Enforce ratio limits: 0.2 to 0.8
                    if (ratio < 0.2) {
                        newTopHeight = topRowsHeight + (availableHeight * 0.2)
                        newBottomHeight = totalHeight - newTopHeight - splitterHeight
                    } else if (ratio > 0.8) {
                        newTopHeight = topRowsHeight + (availableHeight * 0.8)
                        newBottomHeight = totalHeight - newTopHeight - splitterHeight
                    }

                    this.topHeight = newTopHeight
                    this.bottomHeight = newBottomHeight
                },
                stopDrag() {
                    if (this.isDragging) {
                        this.isDragging = false
                        this.saveSplitterPosition()
                    }
                },
                saveSplitterPosition() {
                    const container = document.querySelector('.chat-container')
                    const totalHeight = container.clientHeight
                    const topRowsHeight = 48 + 12 + 48 + 12
                    const bottomRowHeight = 48 + 12
                    const availableHeight = totalHeight - 8 - topRowsHeight - bottomRowHeight

                    const ratio = (this.topHeight - topRowsHeight) / availableHeight
                    localStorage.setItem('chat-splitter-ratio', ratio.toString())
                },
                onFormatClick() {
                    this.loadFormatSettings()
                    this.formatValidationState = null
                    this.formatErrorMessage = ''
                    this.formatModalOpen = true

                    this.$nextTick(() => {
                        if (this.$refs.formatTextarea) {
                            this.$refs.formatTextarea.focus()
                        }
                    })
                },
                async onFormatCheck() {
                    try {
                        const schema = JSON.parse(this.formatSchema)

                        const response = await fetch('/api/checkformat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ schema }),
                        })

                        const result = await response.json()

                        if (result.valid) {
                            this.formatValidationState = 'valid'
                            this.formatErrorMessage = ''
                        } else {
                            this.formatValidationState = 'invalid'
                            this.formatErrorMessage = result.error || 'Invalid JSON Schema'
                        }
                    } catch (err) {
                        this.formatValidationState = 'invalid'
                        this.formatErrorMessage = err.message || 'Failed to validate schema'
                    }
                },
                onFormatTextareaInput() {
                    this.formatValidationState = null
                    this.formatErrorMessage = ''
                },
                onFormatOk() {
                    this.saveFormatSettings()
                    this.formatModalOpen = false
                },
                onFormatCancel() {
                    this.formatModalOpen = false
                    this.formatValidationState = null
                    this.formatErrorMessage = ''
                },
                onOptionsClick() {
                    console.log('Options button clicked')
                },
                onLoadClick() {
                    console.log('Load button clicked')
                },
                onSaveClick() {
                    console.log('Save button clicked')
                },
                onSendClick() {
                    console.log('Send button clicked')
                },
                onCopyAllClick() {
                    console.log('Copy all to clipboard')
                },
                onCopyPayloadClick() {
                    console.log('Copy payload to clipboard')
                },
                onSaveAllClick() {
                    console.log('Save all to file')
                },
                onSavePayloadClick() {
                    console.log('Save payload to file')
                },
                onRequestScroll(e) {
                    const scrollTop = e.target.scrollTop
                    if (this.$refs.requestLabel) {
                        this.$refs.requestLabel.style.opacity = scrollTop > 0 ? '0' : '1'
                    }
                },
                onResponseScroll(e) {
                    const scrollTop = e.target.scrollTop
                    if (this.$refs.responseLabel) {
                        this.$refs.responseLabel.style.opacity = scrollTop > 0 ? '0' : '1'
                    }
                },
                handleEscKey(e) {
                    if (e.key === 'Escape' && this.formatModalOpen) {
                        this.onFormatCancel()
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
