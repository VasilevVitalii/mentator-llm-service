<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Mentator LLM Service</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }
        .stat-widget {
            flex: 1 1 300px;
            min-width: 300px;
            max-width: 400px;
            height: 150px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .stat-widget h3 {
            margin: 0 0 6px 0;
            font-size: 16px;
            font-weight: bold;
            color: var(--b-main1);
            text-transform: lowercase;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 13px;
            gap: 8px;
        }
        .stat-row-label {
            color: #666;
            text-transform: lowercase;
            flex-shrink: 0;
        }
        .stat-row-value {
            font-weight: bold;
            color: var(--b-main1);
            text-align: right;
        }
        .stat-widget-warning {
            background-color: var(--b-warn2);
            border-color: var(--b-warn1);
        }
        .stat-row-value-link {
            font-weight: bold;
            color: var(--b-main1);
            text-align: right;
            cursor: pointer;
            text-decoration: underline;
        }
        .stat-row-value-link:hover {
            color: #007d7d;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="banner">
            <div class="banner-title">
                <a href="/">MENTATOR-LLM-SERVICE, version {{ version }}</a>
            </div>
            <div class="banner-subtitle">statistics</div>
        </div>

        <div class="main-content">
            <div class="stats-container">
                <!-- Server Info -->
                <div class="stat-widget">
                    <h3>server info</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">start time</span>
                            <span class="stat-row-value">{{ serverStartTime }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">uptime</span>
                            <span class="stat-row-value">{{ serverUptime }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">queue size</span>
                            <span class="stat-row-value">{{ queueSize }}</span>
                        </div>
                    </div>
                </div>

                <!-- GPU Info -->
                <div class="stat-widget">
                    <h3>gpu info</h3>
                    <div v-if="gpuInfo">
                        <div class="stat-row">
                            <span class="stat-row-label">type</span>
                            <span class="stat-row-value">{{ gpuInfo.type }}</span>
                        </div>
                        <div v-if="gpuInfo.device" class="stat-row">
                            <span class="stat-row-label">device</span>
                            <span class="stat-row-value">{{ gpuInfo.device }}</span>
                        </div>
                        <div v-if="gpuInfo.totalVramMb !== null" class="stat-row">
                            <span class="stat-row-label">total vram</span>
                            <span class="stat-row-value">{{ gpuInfo.totalVramMb }} mb</span>
                        </div>
                        <div v-if="gpuInfo.usedVramMb !== null" class="stat-row">
                            <span class="stat-row-label">used vram</span>
                            <span class="stat-row-value">{{ gpuInfo.usedVramMb }} mb</span>
                        </div>
                    </div>
                    <div v-else class="stat-label">gpu info unavailable</div>
                </div>

                <!-- Current Model -->
                <div class="stat-widget">
                    <h3>current model</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">count models</span>
                            <span class="stat-row-value-link" @click="onModelsClick">{{ modelsCount }}</span>
                        </div>
                        <div v-if="currentModel">
                            <div class="stat-row">
                                <span class="stat-row-label">name</span>
                                <span class="stat-row-value">{{ currentModel.name }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-row-label">size</span>
                                <span class="stat-row-value">{{ currentModel.sizeMb }} mb</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-row-label">loaded at</span>
                                <span class="stat-row-value">{{ currentModel.loadTime }}</span>
                            </div>
                        </div>
                        <div v-else class="stat-label">no model loaded</div>
                    </div>
                </div>

                <!-- System Resources -->
                <div class="stat-widget">
                    <h3>system resources</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">process memory (RSS)</span>
                            <span class="stat-row-value">{{ memoryUsageMb }} mb</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">process memory (heap)</span>
                            <span class="stat-row-value">{{ memoryHeapMb }} mb</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">process memory (external)</span>
                            <span class="stat-row-value">{{ memoryExternalMb }} mb</span>
                        </div>
                    </div>
                </div>

                <!-- Request Statistics - Last 1 hour -->
                <div class="stat-widget" :class="{ 'stat-widget-warning': stats1h.failed > 0 }">
                    <h3>requests (last 1 hour)</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">successful requests</span>
                            <span class="stat-row-value">{{ stats1h.success }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">failed requests</span>
                            <span class="stat-row-value">{{ stats1h.failed }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 execution time</span>
                            <span class="stat-row-value">{{ stats1h.p95PromptDuration }} ms</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 queue wait</span>
                            <span class="stat-row-value">{{ stats1h.p95QueueDuration }} ms</span>
                        </div>
                    </div>
                </div>

                <!-- Request Statistics - Last 3 hours -->
                <div class="stat-widget" :class="{ 'stat-widget-warning': stats3h.failed > 0 }">
                    <h3>requests (last 3 hours)</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">successful requests</span>
                            <span class="stat-row-value">{{ stats3h.success }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">failed requests</span>
                            <span class="stat-row-value">{{ stats3h.failed }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 execution time</span>
                            <span class="stat-row-value">{{ stats3h.p95PromptDuration }} ms</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 queue wait</span>
                            <span class="stat-row-value">{{ stats3h.p95QueueDuration }} ms</span>
                        </div>
                    </div>
                </div>

                <!-- Request Statistics - Last 24 hours -->
                <div class="stat-widget" :class="{ 'stat-widget-warning': stats24h.failed > 0 }">
                    <h3>requests (last 24 hours)</h3>
                    <div>
                        <div class="stat-row">
                            <span class="stat-row-label">successful requests</span>
                            <span class="stat-row-value">{{ stats24h.success }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">failed requests</span>
                            <span class="stat-row-value">{{ stats24h.failed }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 execution time</span>
                            <span class="stat-row-value">{{ stats24h.p95PromptDuration }} ms</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">p95 queue wait</span>
                            <span class="stat-row-value">{{ stats24h.p95QueueDuration }} ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models Modal -->
        <div v-if="modelsModalOpen" class="modal-backdrop" @click.self="onModelsClose" @keydown.esc="onModelsClose">
            <div class="modal-window" role="dialog" aria-labelledby="models-modal-title" aria-modal="true">
                <h2 id="models-modal-title" class="modal-title">Available Models</h2>

                <div class="modal-form-group">
                    <div v-if="models.length > 0" style="font-family: monospace; font-size: 13px; line-height: 1.6;">
                        <div v-for="(model, index) in models" :key="model.name" style="margin-bottom: 8px;">
                            {{ formatModelDisplay(model) }}
                        </div>
                    </div>
                    <div v-else style="color: #666; font-size: 13px;">
                        No models available
                    </div>
                </div>

                <div class="modal-controls">
                    <div class="modal-left-controls"></div>
                    <div class="modal-right-controls">
                        <button class="form-button width-120" @click="onModelsClose">close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/lib/vue.global.prod.js"></script>
    <script type="module">
        import { formatDateTime, formatDuration } from '/static/lib/time-utils.js'

        const { createApp } = Vue

        createApp({
            data() {
                return {
                    version: '0.0.0',
                    serverStartTime: '',
                    serverStartTimestamp: 0,
                    serverUptime: '',
                    currentModel: null,
                    gpuInfo: null,
                    memoryUsageMb: 0,
                    memoryHeapMb: 0,
                    memoryExternalMb: 0,
                    queueSize: 0,
                    stats1h: {
                        total: 0,
                        success: 0,
                        failed: 0,
                        avgPromptDuration: 0,
                        avgQueueDuration: 0,
                        p95PromptDuration: 0,
                        p95QueueDuration: 0,
                    },
                    stats3h: {
                        total: 0,
                        success: 0,
                        failed: 0,
                        avgPromptDuration: 0,
                        avgQueueDuration: 0,
                        p95PromptDuration: 0,
                        p95QueueDuration: 0,
                    },
                    stats24h: {
                        total: 0,
                        success: 0,
                        failed: 0,
                        avgPromptDuration: 0,
                        avgQueueDuration: 0,
                        p95PromptDuration: 0,
                        p95QueueDuration: 0,
                    },
                    pollInterval: null,
                    uptimeInterval: null,
                    models: [],
                    modelsModalOpen: false,
                }
            },
            computed: {
                modelsCount() {
                    return this.models.length
                }
            },
            mounted() {
                // Load version
                fetch('/state/version')
                    .then(res => res.json())
                    .then(data => {
                        this.version = data.version
                    })
                    .catch(err => {
                        console.error('Failed to load version:', err)
                    })

                // Load models
                this.loadModels()

                // Load initial statistics
                this.loadStatistics()

                // Poll statistics every 10 seconds
                this.pollInterval = setInterval(() => {
                    this.loadStatistics()
                }, 10000)

                // Update uptime every second
                this.uptimeInterval = setInterval(() => {
                    this.updateUptime()
                }, 1000)

                // Handle ESC key globally
                document.addEventListener('keydown', this.handleEscKey)
            },
            beforeUnmount() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval)
                }
                if (this.uptimeInterval) {
                    clearInterval(this.uptimeInterval)
                }
                document.removeEventListener('keydown', this.handleEscKey)
            },
            methods: {
                async loadModels() {
                    try {
                        const response = await fetch('/state/models')
                        const data = await response.json()

                        // Sort models: 1) by size (ascending), 2) by name (alphabetically)
                        this.models = (data.models || []).sort((a, b) => {
                            if (a.sizeKb !== b.sizeKb) {
                                return a.sizeKb - b.sizeKb
                            }
                            return a.name.localeCompare(b.name)
                        })
                    } catch (err) {
                        console.error('Failed to load models:', err)
                        this.models = []
                    }
                },
                formatModelDisplay(model) {
                    const sizeMb = Math.ceil(model.sizeKb / 1024)
                    return `${model.name} (${sizeMb} MB)`
                },
                onModelsClick() {
                    this.modelsModalOpen = true
                },
                onModelsClose() {
                    this.modelsModalOpen = false
                },
                handleEscKey(e) {
                    if (e.key === 'Escape' && this.modelsModalOpen) {
                        this.onModelsClose()
                    }
                },
                loadStatistics() {
                    fetch('/state')
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`)
                            }
                            return res.json()
                        })
                        .then(data => {
                            // Server info
                            this.serverStartTimestamp = data.serverStartTimestamp
                            this.serverStartTime = formatDateTime(new Date(data.serverStartTimestamp))
                            this.serverUptime = formatDuration(data.serverUptimeSeconds)

                            // Current model
                            if (data.currentModel) {
                                this.currentModel = {
                                    name: data.currentModel.name,
                                    sizeMb: data.currentModel.sizeMb,
                                    loadTime: formatDateTime(new Date(data.currentModel.loadTimestamp)),
                                }
                            } else {
                                this.currentModel = null
                            }

                            // GPU info
                            this.gpuInfo = data.gpuInfo || null

                            // System resources
                            this.memoryUsageMb = data.memoryUsageMb
                            this.memoryHeapMb = data.memoryHeapMb
                            this.memoryExternalMb = data.memoryExternalMb
                            this.queueSize = data.queueSize

                            // Statistics
                            if (data.stats1h) this.stats1h = data.stats1h
                            if (data.stats3h) this.stats3h = data.stats3h
                            if (data.stats24h) this.stats24h = data.stats24h
                        })
                        .catch(err => {
                            console.error('Failed to load statistics:', err)
                        })
                },
                updateUptime() {
                    if (this.serverStartTimestamp > 0) {
                        const uptimeSeconds = Math.floor((Date.now() - this.serverStartTimestamp) / 1000)
                        this.serverUptime = formatDuration(uptimeSeconds)
                    }
                },
            },
        }).mount('#app')
    </script>
</body>
</html>
